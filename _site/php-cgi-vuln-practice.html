<h1 id="x00-">0x00 背景</h1>

<p>中午看到<a href="https://www.leavesongs.com/">P牛</a>20分钟拿下WebShell很是崇拜，大家问其究竟得知是<code>xxx.jpg/.php</code>被解析成php脚本轻松拿下，抱着自愧不如的心理来学习一下。</p>

<ul>
  <li><a href="http://www.80sec.com/nginx-securit.html">http://www.80sec.com/nginx-securit.html</a></li>
  <li><a href="http://www.laruence.com/2009/11/13/1138.html">Nginx(PHP/fastcgi)的PATH_INFO问题</a></li>
  <li><a href="http://www.laruence.com/2010/05/20/1495.html">Nginx + PHP CGI的一个可能的安全漏洞</a></li>
  <li><a href="https://nealpoole.com/blog/2011/04/setting-up-php-fastcgi-and-nginx-dont-trust-the-tutorials-check-your-configuration/">Setting up PHP-FastCGI and nginx? Don’t trust the tutorials: check your configuration!</a></li>
</ul>

<p>上面的链接主要阐述的是，在Nginx服务器上由于PHP的cgi.fix_pathinfo默认为开启状态，加上Web服务器上没有对应地安全处理最终导致解析漏洞的发生。</p>

<h1 id="x01-">0x01 实践</h1>

<p>这个漏洞从10年被发现，而如今我测试的php-5.6.25版本中cgi.fix_pathinfo仍为默认开启状态，由于Web安全是个贯穿性的整体，下面就从不同平台上的Web服务器进行测试实践。</p>

<h2 id="windows-">Windows 平台</h2>

<p>在Windows平台上，运维者如果在搭建好环境后在实际环境中使用默认配置，将请求未做处理就传入php的fastcgi，解析问题就随之而来了。</p>

<h3 id="nginx">Nginx</h3>

<p>参考<a href="http://blog.qiji.tech/archives/3092">这里</a>搭建好环境，测试漏洞存在：</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/2017/02/16/1.jpg" alt="" /></p>

<h3 id="iis">IIS</h3>

<p>IIS服务器在<a href="http://www.cnblogs.com/haocool/archive/2012/10/14/windows-8-iis-to-configure-php-runtime-environment.html">搭建</a>好后，使用fastcgi模块处理php脚本，同样存在问题：</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/2017/02/16/2.jpg" alt="" /></p>

<h2 id="linux-">Linux 平台</h2>

<p>在Linux平台下我直接是Ubuntu apt-get 安装的nginx、php和php5-fpm，首先是随便请求一个php文件，浏览器中响应如下：</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/2017/02/16/3.jpg" alt="" /></p>

<p>像这种只是响应很简单的body而不是nginx的404页面，很有可能说明是直接将请求传递到了fastcgi中。（Widnwos平台上也是类似的道理）</p>

<p>可是在访问<code>http://192.168.1.124/larry.txt/.php</code>页面时出现了<code>Access denied.</code>信息拒绝访问，查看error日志和Google一番之后得知php在5.3.9版本中对php-fpm添加了<a href="https://bugs.php.net/bug.php?id=55181">security.limit_extensions</a>选项，防止Web服务的错误配置而带来的php代码执行。所以我在<code>/etc/php5/fpm/pool.d/www.conf</code>中添加<code>security.limit_extensions = .php .txt</code>，再重启php5-fpm就能复现解析漏洞了：</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/2017/02/16/4.jpg" alt="" /></p>

<h1 id="x02-">0x02 感悟</h1>

<p>探究这个漏洞久了总感觉似曾相识，最后才恍然大悟是看过的<a href="http://172.16.24.178/www.owasp.org.cn/OWASP_Training/Upload_Attack_Framework.pdf">Upload_Attack_Framework</a>中的内容，当初理解实践地不够深入现在只能再慢慢还了。对比之下我这个探究也“自愧不如”了。</p>

<p>在Google过程中发现orange大牛在hitcon大会演讲的ppt中也有提到过该问题的相关思考，其中针对某种防御形式的绕过也是蛮有意思的，有兴趣的同学可以<a href="https://hitcon.org/2015/CMT/download/day1-c-r0.pdf">瞅瞅</a>。</p>

<p>比较有意思的是发现在国内某个比较火的php环境集成软件中，也有一键化部署nginx+php的环境，而其中的默认配置不可避免地会被拿下，结合浏览器的关键字
搜索和对应存在上传图片的网站，这样我也能够“20分钟”轻松拿下了：</p>

<p><img src="http://ojyzyrhpd.bkt.clouddn.com/2017/02/16/5.jpg" alt="" /></p>

